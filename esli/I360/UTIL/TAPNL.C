#include <stdio.h>
#include <conio.h>
#include <io.h>
#include <string.h>
#include <stdlib.h>
#include <fcntl.h>
#include <\sys\stat.h>
#include <mem.h>
#include "trn.h"
#include "write.h"

int main(argc,argv)
char **argv;
int argc;
{
 static long i,k;
 static int j,L;
 static char FILE_IN[80];
 static char FILE_OUT[80];
 struct stat statbuf;
 static int IN;
 static int OUT;
 static long OFF_PREV;
 static long OFF_NEXT;
 static long LEN_BLOCK;
 static long OFF_NOW;
 static char PR=0x11;
 static int CCC, TTT;
 static int CCCD,TTTD;
 static unsigned long OFF_HEADER;
 static unsigned int LEN_READ;
 static unsigned int minl,maxl;

 static char ADR[8]={
    0x00,0x00, 0x00,0x00, 0x00,0x00,0x00,0x00
                     };
 static char COMPP2[0x18]=
   {0x06,0x00,0x0d,0xd8,  0x10,0x00,0x00,0x08,
    0x00,0x00,0x00,0x00,  0x00,0x00,0x00,0x00,
    0x07,0x00,0x32,0xaa,  0x60,0x00,0x00,0x06
   };
 static char COMPP3[0x18]=
   {0x11,0x00,0x0b,0xf0,  0x20,0x00,0x00,0x08,
    0x00,0x00,0x00,0x00,  0x00,0x00,0x00,0x00,
    0x07,0x00,0x32,0xaa,  0x60,0x00,0x00,0x06
   };
 static char COMPP[0x38]=
   {0x92,0x0d,0xa2,0x80,  0x60,0x00,0x00,0x08,
    0x92,0x0d,0xa2,0x88,  0x60,0x00,0x00,0x08,
    0x07,0x00,0x32,0xaa,  0x60,0x00,0x00,0x06,
    0x1f,0x00,0x31,0xa6,  0x60,0x00,0x00,0x01,
    0x31,0x00,0x32,0xac,  0x60,0x00,0x00,0x05,
    0x08,0x00,0x32,0xd8,  0x60,0x00,0x00,0x05,
    0x08,0x00,0x32,0xf0,  0x60,0x00,0x00,0x05

   };
	static char COMPP0[0x38]=
   {0x00,0x00,0x00,0x00,  0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,  0x00,0x00,0x00,0x00,
    0x07,0x00,0x32,0xaa,  0x60,0x00,0x00,0x06,
    0x1f,0x00,0x31,0xa6,  0x60,0x00,0x00,0x01,
    0x31,0x00,0x32,0xac,  0x60,0x00,0x00,0x05,
    0x08,0x00,0x32,0xd8,  0x60,0x00,0x00,0x05,
    0x08,0x00,0x32,0xf0,  0x60,0x00,0x00,0x05

   };

	static char COMPP4[0x38]=
   {0x92,0x0d,0xa2,0x80,  0x60,0x00,0x00,0x08,
    0x92,0x0d,0xa2,0x88,  0x60,0x00,0x00,0x08,
    0x07,0x00,0x32,0xaa,  0x40,0x00,0x00,0x06,
    0x1f,0x00,0x31,0xa6,  0x40,0x00,0x00,0x01,
    0x31,0x00,0x32,0xac,  0x60,0x00,0x00,0x05,
    0x08,0x00,0x32,0xd8,  0x60,0x00,0x00,0x05,
    0x08,0x00,0x32,0xf0,  0x60,0x00,0x00,0x05

   };
	static char COMPP04[0x38]=
   {0x0e,0x0d,0x99,0x08,  0x20,0x00,0x00,0x8c,
    0x1a,0x00,0x00,0x00,  0x20,0x00,0x00,0x05,
    0x07,0x00,0x32,0xaa,  0x40,0x00,0x00,0x06,
    0x1f,0x00,0x31,0xa6,  0x40,0x00,0x00,0x01,
    0x31,0x00,0x32,0xac,  0x60,0x00,0x00,0x05,
    0x08,0x00,0x32,0xd8,  0x60,0x00,0x00,0x05,
    0x08,0x00,0x32,0xf0,  0x60,0x00,0x00,0x05

   };
 static char FF00[80]={
    0xff,0x00,0xff,0x00,  0xff,0x00,0xff,0x00,
    0xff,0x00,0xff,0x00,  0xff,0x00,0xff,0x00,
    0xff,0x00,0xff,0x00,  0xff,0x00,0xff,0x00,
    0xff,0x00,0xff,0x00,  0xff,0x00,0xff,0x00,
    0xff,0x00,0xff,0x00,  0xff,0x00,0xff,0x00,
    0xff,0x00,0xff,0x00,  0xff,0x00,0xff,0x00,
    0xff,0x00,0xff,0x00,  0xff,0x00,0xff,0x00,
    0xff,0x00,0xff,0x00,  0xff,0x00,0xff,0x00,
    0xff,0x00,0xff,0x00,  0xff,0x00,0xff,0x00,
    0xff,0x00,0xff,0x00,  0xff,0x00,0xff,0x00
			 };
 static char HEADER[80]={
    0x00,0x00,0x00,0x00,  0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,  0xf4,0x70,0x06,0x01,
    0x66,0x63,0xb2,0x4d,  0xf0,0x02,0xe7,0xe7
			 };

 static char VOL[80]={0xe5,0xd6,0xd3,0xf1,
   0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,
   0xf0};
 static char HDR1[80]={0xc8,0xc4,0xd9,0xf1,

   0xc1,0x40,0x40,0x40,0x40,0x40,0x40,0x40,

   0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,
   0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,
   0xf0,0xf0,0xf0,0xf1,
   0xf0,0xf0,0xf0,0xf1,
   0x40,0x40,0x40,0x40,0x40,0x40,
   0x40,0xf0,0xf0,0xf0,0xf0,0xf0,
   0x40,0xf0,0xf0,0xf0,0xf0,0xf0,
   0xf0,
   0xf0,0xf0,0xf0,0xf0,0xf0,0xf0
   };
 static char HDR2[80]={0xc8,0xc4,0xd9,0xf2,
   0xe5,
   0xf0,0xf7,0xf3,0xf1,0xf2,
   0xf0,0xf7,0xf2,0xf9,0xf4,
   0xf3,
   0xf0,
   0xc1,0x40,0x40,0x40,0x40,0x40,0x40,0x40,
   0x64,
   0xc1,0x40,0x40,0x40,0x40,0x40,0x40,0x40,
   0x40,0x40,0x40,0x40,
   0xe2
   };
 static char EOF1[80]={0xc5,0xd6,0xc6,0xf1,

   0xc1,0x40,0x40,0x40,0x40,0x40,0x40,0x40,

   0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,
   0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,
   0xf0,0xf0,0xf0,0xf1,
   0xf0,0xf0,0xf0,0xf1,
   0x40,0x40,0x40,0x40,0x40,0x40,
   0x40,0xf0,0xf0,0xf0,0xf0,0xf0,
   0x40,0xf0,0xf0,0xf0,0xf0,0xf0,
   0xf0,
   0xf0,0xf0,0xf0,0xf4,0xf3,0xf1
   };
 static char EOF2[80]={0xc5,0xd6,0xc6,0xf2,
   0xe5,
   0xf0,0xf7,0xf3,0xf1,0xf2,
   0xf0,0xf7,0xf2,0xf9,0xf4,
   0xf3,
   0xf0,
   0xc1,0x40,0x40,0x40,0x40,0x40,0x40,0x40,
   0x64,
   0xc1,0x40,0x40,0x40,0x40,0x40,0x40,0x40,
   0x40,0x40,0x40,0x40,
   0xe2
   };
 static char EF[80]={0xc5,0xd6,0xc6,0xf1};
 static char BUFER[40000];
 static int RET;
 static char STR_B[80];
 static char STR_L[80];
 static char STR_R[80];
 static char STR_LB[80];
 static char STR_NREC[80];
 static int NNREC;

char    title[] =  "\n    TapNl - Convertor tape's\n"
                   "Copyright (C) 1996 from 2:5030/269.0\n"
                   "\n";

char    usage[] =  "\n\nUsage: tapnl <FILE-IN> <FILE-OUT> [/WTM]\n"
                   "\n";

char    absend[] = "Input file is ABSEND\n";

char    smwrong[] = "samething wrong\n";

                fputs( title, stdout );

             if (argc<3) { fputs( usage, stderr ); return(32);};

 strcpy(FILE_IN,argv[1]);
 strcpy(FILE_OUT,argv[2]);

 IN=open(FILE_IN,O_RDONLY|O_BINARY);
 if (IN<=0) {fputs(absend,stderr);return(16);}

printf("\n\n  Create tape of ESLI format");

printf("\n\n %s --> %s (     ",FILE_IN,FILE_OUT);

 fstat(IN,&statbuf);
 OUT=open(FILE_OUT,O_WRONLY|O_BINARY|O_TRUNC|O_CREAT,S_IREAD|S_IWRITE);
 OFF_PREV=0;

 /*********TM*********/
if (strncmp(argv[3],"/WTM",4)==0) WRITE(OUT,BUFER,18,0xff);

/*********records*******/
 j=0;

 NNREC=0;

NEXTREAD:
 RET=read(IN,&LEN_READ,2);
 LEN_READ=(LEN_READ>>8)+((LEN_READ&0x00ff)<<8);
// if (LEN_READ==0) getch();
 if (RET<2) goto ENDOFFILE;
 if (LEN_READ>32767) { fputs(smwrong,stderr); goto ENDOFFILE;}
 RET=read(IN,BUFER,LEN_READ);
	printf("\\\\\%03ld\%)",(long)((long)(tell(IN)*100) / statbuf.st_size));

if (LEN_READ<minl) minl=LEN_READ;
if (LEN_READ>maxl) maxl=LEN_READ;



 if (RET<LEN_READ)
	 {printf("RET=%d ",RET);getch();
		NNREC++;
		BUFER[0]=(LEN_READ>>8);BUFER[1]=LEN_READ&0x00ff;
		WRITE(OUT,BUFER,LEN_READ,0x11);
		goto ENDOFFILE;
	 }
 NNREC++;
 WRITE(OUT,BUFER,LEN_READ,0x11);

 goto NEXTREAD;
ENDOFFILE:
 /**********TM***********/
 WRITE(OUT,FF00,18,0xff);

 /*********TM*********/
 WRITE(OUT,FF00,18,0xff);

 /******LAST REC******/
 WRITE(OUT,FF00,0,0xff);

 close(IN);
 close(OUT);

printf("\n컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴\nRecord=%04d, LRECL=%04d-%04d\07\n",
				    NNREC, minl, maxl);

}
